# 06b. 入室準備モーダル実装

## 概要

認証後に必ず表示される入室準備モーダルの実装。
ユーザーが表示名とアバターを設定してからルームに入室するためのインターフェース。

## 機能仕様

### 表示タイミング

- **認証後に必ず表示**: Google認証・ゲスト認証のどちらでも
- **強制表示**: キャンセルできるが、入室せずにトップページに戻る
- **再表示**: ルーム内の「設定変更」からも呼び出し可能

### 入力フィールド

#### 1. 表示名設定

**Googleユーザーの場合**
- `profiles.name`を初期値として表示
- 編集可能（ユーザーが変更できる）
- 空欄エラーバリデーション

**ゲストユーザーの場合**
- 初期値: 空または`"ゲスト1234"`のようなランダム名
- 必須入力フィールド
- 文字数制限（1〜20文字程度）

#### 2. アバター選択

- **5色のオプション**: `blue`, `purple`, `cyan`, `indigo`, `green`
- **ビジュアル表示**: SVGアバターを横並びで表示
- **選択状態**: クリックで選択、選択中はハイライト
- **プレビュー**: 選択中のアバターを大きめに表示

### アクションボタン

#### 1. 入室ボタン

- **ラベル**: 「ルームに入る」
- **機能**: 設定を保存して`/room/main-room`へ遷移
- **無効化条件**:
  - 表示名が空の場合
  - ルームが満員の場合（5/5）
  - 接続エラーが発生している場合

#### 2. キャンセルボタン

- **ラベル**: 「キャンセル」
- **機能**: モーダルを閉じてトップページ（`/`）に戻る
- **認証状態**: ログアウトさせる

### 状態表示

#### 1. ルーム状態表示

- **接続中**: 「ルームに接続中...」
- **人数表示**: 「3 / 5 人」のように現在の接続数を表示
- **満員時**: 「ルームが満員です（5/5）」を赤色で表示
- **エラー時**: 「接続エラーが発生しました」

#### 2. リアルタイム更新

- **人数監視**: Presenceチャンネルでリアルタイムに人数を監視
- **自動更新**: 空きが出たら自動で入室ボタンを有効化

## デザイン仕様

### Figmaデザイン準拠

以下のデザインを完全に再現する：
https://www.figma.com/design/vES3VewH8Qo1MA0Au0oujK/Supabase-Gather?node-id=23-59&t=h312ToASd1B6kW07-0

### UIコンポーネント

- **モーダルベース**: shadcn/ui `Dialog`コンポーネント
- **入力フィールド**: shadcn/ui `Input`コンポーネント
- **ボタン**: shadcn/ui `Button`コンポーネント
- **アバターセレクター**: カスタムコンポーネント

### レスポンシブデザイン

- **デスクトップ**: 中央にモーダル表示
- **モバイル**: フルスクリーンモーダル
- **アバター選択**: モバイルでは縦並びに変更

## 技術実装

### 必要なコンポーネント

#### 1. メインモーダルコンポーネント

```typescript
// src/features/room-entry/ui/room-entry-modal.tsx
export function RoomEntryModal() {
  // 表示名管理
  // アバター選択管理
  // ルーム状態監視
  // 入室処理
}
```

#### 2. アバターセレクターコンポーネント

```typescript
// src/features/avatar/ui/avatar-selector.tsx
export function AvatarSelector() {
  // 5色のアバター表示
  // 選択状態管理
  // プレビュー表示
}
```

#### 3. ルーム状態表示コンポーネント

```typescript
// src/features/rooms/ui/room-status-display.tsx
export function RoomStatusDisplay() {
  // 接続中状態
  // 人数表示
  // エラー状態
}
```

### 状態管理設計

#### モーダル状態

```typescript
type RoomEntryState = {
  displayName: string
  selectedAvatar: AvatarType
  isConnecting: boolean
  roomStatus: 'checking' | 'available' | 'full' | 'error'
  currentOccupancy: number
  maxOccupancy: number
  error: string | null
}
```

#### フック統合

- `useAuth()`: 認証情報の取得
- `useRoomStatus()`: ルーム状態の監視
- `useAvatar()`: アバター管理

### ビジネスロジック

#### 入室処理フロー

1. **バリデーション**:
   - 表示名が入力されているか
   - アバターが選択されているか
   - ルームに空きがあるか

2. **データ保存**:
   - Googleユーザー: `profiles`テーブルを更新
   - ゲストユーザー: ローカル状態に保存

3. **ルーム遷移**:
   - ルート: `/room/main-room`
   - Presenceチャンネルに参加
   - モーダルを閉じる

#### キャンセル処理フロー

1. **状態リセット**: 入力値をクリア
2. **認証解除**: ログアウト処理
3. **ルート遷移**: トップページ（`/`）に戻る

## エラーハンドリング

### バリデーションエラー

- **表示名空欄**: 「表示名を入力してください」
- **表示名長すぎ**: 「20文字以内で入力してください」
- **特殊文字禁止**: 「特殊文字は使用できません」

### ルーム接続エラー

- **満員時**: 「ルームが満員です。しばらくお待ちください」
- **接続エラー**: 「ルームに接続できません。しばらくしてから再試行してください」
- **タイムアウト**: 「接続がタイムアウトしました。網絡接続を確認してください」

### 自動復旧機能

- **再接続試行**: 3回まで自動で再試行
- **人数監視継続**: 満員時も定期的にチェック
- **状態更新**: リアルタイムでUIを更新

## 実装順序

1. **モーダルベース作成**: shadcn/ui Dialogでコンテナ作成
2. **アバターセレクター**: SVGアバター選択機能
3. **ルーム状態監視**: Presenceで人数チェック
4. **入力フォーム**: 表示名 + バリデーション
5. **入室処理**: データ保存 + ルート遷移
6. **エラーハンドリング**: 各種エラー状態の処理
7. **デザイン調整**: Figmaデザインとの完全一致

## 関連ファイル

- `src/features/room-entry/ui/room-entry-modal.tsx` - メインモーダル
- `src/features/avatar/ui/avatar-selector.tsx` - アバター選択
- `src/features/rooms/ui/room-status-display.tsx` - ルーム状態
- `src/shared/ui/dialog/` - モーダルベース
- `src/shared/ui/input/` - 入力フィールド