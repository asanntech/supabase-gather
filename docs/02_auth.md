# 02. 認証システム（Google + ゲスト）

## 概要

Supabase Gatherでは2つの認証方式をサポートする：

1. **Googleログイン**：Supabase Authを利用した本格認証
2. **ゲストログイン**：ローカル専用の一時的な認証

## Googleログイン

### 仕組み

- Supabase Auth の Google Provider を使用
- ログインユーザーは `auth.users` + `profiles` テーブルで管理
- OAuth2.0によるセキュアな認証

### データ管理

- 初回ログイン時：`profiles`テーブルにレコード作成
- Googleの表示名を初期値として設定（ユーザーが編集可能）
- `profiles.name` と `profiles.avatar_type` を永続化

## ゲストログイン（ローカル専用）

### 仕組み

- Supabase Authは**使用しない**
- フロントエンド側でランダムID発行（UUID文字列）
- **名前のデフォルト値**：「ゲスト」（ユーザーが変更可能）
- アバタータイプのデフォルト値：「blue」（ユーザーが選択可能）

### データ管理

- DBには「ゲストユーザーの恒久的なレコードは作成しない」
- メッセージ投稿時に `display_name` と `avatar_type` を直接保存
- セッション終了で情報は消失

## セキュリティ上の注意点

### RLS（Row Level Security）の制限

- ゲストはSupabase Authを使わないため、**ユーザーごとのRLS制限は基本的に不可能**
- MVP段階では「1つの公開ルーム」「全投稿が誰でも読める」設計のため問題なし
- **全ユーザー（Anon含む）読み書きOKのRLS**設定で対応

### 将来の拡張性

- 「ユーザーごとの履歴管理」「DM機能」などが必要になった場合：
  - ゲスト機能をSupabase Authの匿名ログインに移行
  - より厳密なRLS設定が可能になる

## 実装のポイント

1. **認証フロー分岐**：ログイン方式により処理を切り分け
2. **データ永続化**：Googleユーザーのみ`profiles`テーブル利用
3. **セッション管理**：ゲストユーザーはメモリのみ、localStorage永続化なし
4. **セキュリティ**：ゲスト用のRLS設定を適切に構成
5. **移行性**：将来のゲスト機能廃止・変更に備えた設計
6. **ユーザーフロー**：認証後は必ず入室準備モーダルを表示

## 認証フローとルーティング

### 認証前

- **アクセス先**: トップページ（`/`）
- **表示内容**: 認証オプション選択画面

### 認証完了後

1. **入室準備モーダル表示**（必須・毎回）
   - Googleユーザー: `profiles`データで初期化
   - ゲストユーザー: デフォルト名「ゲスト」、アバター「blue」で初期化
2. **設定完了後**: ルーム画面（`/room/:room_id`）へ遷移

### 未認証状態でのルーム直アクセス

- `/room/:room_id`への直接アクセス
- 認証ガード機能により`/`へリダイレクト
- 認証完了後に元のルームへ遷移

## 実装詳細

### DDD/Clean Architecture構造

```
src/features/auth/
├── domain/               # ドメインレイヤー
│   ├── entities/         # エンティティ群
│   │   ├── User.ts       # Google/Guestユーザー統合エンティティ
│   │   ├── Profile.ts    # プロファイルエンティティ（DB永続化用）
│   │   ├── GuestUser.ts  # ゲストユーザー専用エンティティ
│   │   └── index.ts      # 統一エクスポート
│   ├── repositories/     # リポジトリインターフェース
│   │   ├── AuthRepository.ts       # 認証操作
│   │   ├── ProfileRepository.ts    # プロファイル管理
│   │   ├── GuestUserRepository.ts  # ゲストユーザー管理
│   │   └── index.ts
│   └── index.ts         # ドメイン層統一エクスポート
├── use-cases/           # ユースケースレイヤー
│   ├── logic/           # ビジネスロジック
│   └── hooks/           # React Query統合hooks
└── ui/                 # UIコンポーネント
```

### エンティティ特徴

- **Zodバリデーション統合**: 型安全性とランタイム検証
- **ファクトリ関数**: Entity作成用の安全な関数
- **ビジネスルール検証**: ドメインロジックの明示的な実行
- **デフォルト値**: GuestUserは「ゲスト」名で自動初期化
- **型安全性**: TypeScript + Zod による完全な型チェック
