# 01. 認証システム（Google + ゲスト）

## 概要

Supabase Gatherでは2つの認証方式をサポートする：

1. **Googleログイン**：Supabase Authを利用した本格認証
2. **ゲストログイン**：ローカル専用の一時的な認証

## Googleログイン

### 仕組み

- Supabase Auth の Google Provider を使用
- ログインユーザーは `auth.users` + `profiles` テーブルで管理
- OAuth2.0によるセキュアな認証

### データ管理

- 初回ログイン時：`profiles`テーブルにレコード作成
- Googleの表示名を初期値として設定（ユーザーが編集可能）
- `profiles.name` と `profiles.avatar_type` を永続化

## ゲストログイン（ローカル専用）

### 仕組み

- Supabase Authは**使用しない**
- フロントエンド側でランダムID発行（UUID文字列）
- 名前・アバターは**毎回入力/選択**が必要

### データ管理

- DBには「ゲストユーザーの恒久的なレコードは作成しない」
- メッセージ投稿時に `display_name` と `avatar_type` を直接保存
- セッション終了で情報は消失

## セキュリティ上の注意点

### RLS（Row Level Security）の制限

- ゲストはSupabase Authを使わないため、**ユーザーごとのRLS制限は基本的に不可能**
- MVP段階では「1つの公開ルーム」「全投稿が誰でも読める」設計のため問題なし
- **全ユーザー（Anon含む）読み書きOKのRLS**設定で対応

### 将来の拡張性

- 「ユーザーごとの履歴管理」「DM機能」などが必要になった場合：
  - ゲスト機能をSupabase Authの匿名ログインに移行
  - より厳密なRLS設定が可能になる

## 実装のポイント

1. **認証フロー分岐**：ログイン方式により処理を切り分け
2. **データ永続化**：Googleユーザーのみ`profiles`テーブル利用
3. **セキュリティ**：ゲスト用のRLS設定を適切に構成
4. **移行性**：将来のゲスト機能廃止・変更に備えた設計
