# 07. チャットリアルタイム機能

## タスク概要

PostgreSQL Changes チャンネルを使用してリアルタイムチャット機能を実装する。

## 実装内容

### 1. メッセージチャンネル設定

```typescript
const messageChannel = supabase
  .channel(`messages:${roomId}`)
  .on('postgres_changes', 
    { event: 'INSERT', schema: 'public', table: 'messages' },
    (payload) => {
      // 新規メッセージ受信処理
    }
  )
  .subscribe()
```

### 2. リアルタイムメッセージ受信

#### 新着メッセージ処理
- INSERTイベントの監視
- ルームIDでのフィルタリング
- メッセージ状態への追加

#### 重複回避
- 自分の送信メッセージのエコーバック無視
- クライアントID での判定
- 一意性確保

### 3. UI更新

#### 自動スクロール
- 新着メッセージ時の自動スクロール
- ユーザースクロール中の自動スクロール停止
- "新着メッセージ"通知

#### 視覚フィードバック
- 新着メッセージのハイライト
- 送信状態の表示
- タイピングインジケーター（将来実装）

### 4. メッセージ同期

#### 初回同期
- ルーム参加時の過去メッセージ取得
- リアルタイムチャンネル接続
- 同期完了の確認

#### 状態整合性
- 接続断・復旧時の同期
- 欠落メッセージの検出・補完
- タイムスタンプでのソート

### 5. パフォーマンス最適化

#### メッセージ制限
- 表示メッセージ数の制限（100件）
- 古いメッセージの自動削除
- 仮想スクロールの準備

#### 更新効率化
- React.memo でのコンポーネント最適化
- 不要な再レンダリング防止
- デバウンス処理

### 6. エラーハンドリング

#### 接続エラー
- チャンネル接続失敗の検出
- 自動再接続試行
- エラー状態表示

#### 送信エラー
- メッセージ送信失敗の処理
- 再送機能
- オフライン対応準備

## 技術仕様

### チャンネル管理
- ルーム参加時に接続
- ルーム退室時に切断
- エラー時の自動再接続

### メッセージフィルタリング
- room_id での完全一致
- created_at でのソート
- 不正データの除外

## 成果物

- リアルタイムメッセージ受信機能
- チャンネル接続・切断管理
- エラーハンドリング機能

## 次のタスク

08_settings_modal.md - 設定変更機能の実装